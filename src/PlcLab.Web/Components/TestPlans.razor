@using PlcLab.Domain
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpFactory

<h3>Test Plans</h3>



@if (IsLoading)
{
    <div>Loading...</div>
}
else
{
    <button class="btn btn-primary mb-2" @onclick="ShowAddPlan">Add Test Plan</button>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Name</th>
                <th>Cases</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var plan in Plans)
            {
                <tr>
                    <td>@plan.Name</td>
                    <td>@plan.TestCases.Count</td>
                    <td>
                        <button class="btn btn-sm btn-secondary me-1" @onclick="() => EditPlan(plan)">Edit</button>
                        <button class="btn btn-sm btn-danger me-1" @onclick="() => DeletePlan(plan)">Delete</button>
                        <button class="btn btn-sm btn-success" @onclick="() => StartPlan(plan)">Start</button>
                        @if (RunningPlanId == plan.Id)
                        {
                            <span class="ms-2"><b>Running...</b> @Progress% - @StatusMessage</span>
                        }
                        @if (LastResultPlanId == plan.Id && !string.IsNullOrEmpty(ResultMessage))
                        {
                            <span class="ms-2 text-success">@ResultMessage</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (ShowPlanDialog)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((EditingPlan?.Id == Guid.Empty) ? "Add Test Plan" : "Edit Test Plan")</h5>
                    <button type="button" class="btn-close" @onclick="CloseDialog"></button>
                </div>
                <div class="modal-body">
                    <input class="form-control mb-2" placeholder="Plan Name" @bind="EditingPlan!.Name" />
                    <h6>Test Cases</h6>
                    <ul class="list-group mb-2">
                        @foreach (var tc in EditingPlan!.TestCases)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>@tc.Name</span>
                                <button class="btn btn-sm btn-danger" @onclick="() => RemoveCase(tc)">Remove</button>
                            </li>
                        }
                    </ul>
                    <input class="form-control mb-2" placeholder="New Case Name" @bind="NewCaseName" />
                    <button class="btn btn-sm btn-outline-primary" @onclick="AddCase">Add Case</button>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
                    <button class="btn btn-primary" @onclick="SavePlan">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@code {
    private List<TestPlan> Plans = new();
    private Guid? RunningPlanId;
    private int Progress;
    private string StatusMessage = string.Empty;
    private string ResultMessage = string.Empty;
    private Guid? LastResultPlanId;

    private async void StartPlan(TestPlan plan)
    {
        if (RunningPlanId != null) return; // Prevent concurrent runs
        RunningPlanId = plan.Id;
        Progress = 0;
        StatusMessage = "Starting test run...";
        ResultMessage = string.Empty;
        LastResultPlanId = null;
        StateHasChanged();
        try
        {
            var client = HttpFactory.CreateClient("Api");
            var response = await client.PostAsJsonAsync($"api/testruns", new { TestPlanId = plan.Id });
            response.EnsureSuccessStatusCode();
            // Simulate progress
            for (int i = 1; i <= 10; i++)
            {
                await Task.Delay(400);
                Progress = i * 10;
                StatusMessage = $"Running step {i} of 10...";
                StateHasChanged();
            }
            StatusMessage = "Test run complete.";
            ResultMessage = $"Test plan '{plan.Name}' completed successfully.";
            LastResultPlanId = plan.Id;
        }
        catch (Exception ex)
        {
            StatusMessage = $"Test run failed: {ex.Message}";
            ResultMessage = string.Empty;
            LastResultPlanId = plan.Id;
        }
        finally
        {
            RunningPlanId = null;
            StateHasChanged();
        }
    }
    private bool IsLoading = true;
    private bool ShowPlanDialog = false;
    private TestPlan? EditingPlan;
    private string NewCaseName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadPlans();
    }

    private async Task LoadPlans()
    {
        IsLoading = true;
        try
        {
            var client = HttpFactory.CreateClient("Api");
            var plans = await client.GetFromJsonAsync<List<TestPlan>>("api/testplans");
            Plans = plans ?? new();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to load test plans: {ex.Message}");
            Plans = new();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void ShowAddPlan()
    {
        EditingPlan = new TestPlan { Id = Guid.Empty, Name = string.Empty, TestCases = new() };
        ShowPlanDialog = true;
        NewCaseName = string.Empty;
    }

    private void EditPlan(TestPlan plan)
    {
        EditingPlan = new TestPlan
        {
            Id = plan.Id,
            Name = plan.Name,
            TestCases = plan.TestCases.Select(tc => new TestCase { Id = tc.Id, Name = tc.Name }).ToList()
        };
        ShowPlanDialog = true;
        NewCaseName = string.Empty;
    }

    private void CloseDialog()
    {
        ShowPlanDialog = false;
        EditingPlan = null;
        NewCaseName = string.Empty;
    }

    private void AddCase()
    {
        if (!string.IsNullOrWhiteSpace(NewCaseName) && EditingPlan != null)
        {
            EditingPlan.TestCases.Add(new TestCase { Id = Guid.NewGuid(), Name = NewCaseName });
            NewCaseName = string.Empty;
        }
    }

    private void RemoveCase(TestCase tc)
    {
        EditingPlan?.TestCases.Remove(tc);
    }

    private async Task SavePlan()
    {
        if (EditingPlan == null) return;
        var client = HttpFactory.CreateClient("Api");
        if (EditingPlan.Id == Guid.Empty)
        {
            // New plan
            var response = await client.PostAsJsonAsync("api/testplans", EditingPlan);
            if (response.IsSuccessStatusCode)
            {
                var created = await response.Content.ReadFromJsonAsync<TestPlan>();
                if (created != null)
                    EditingPlan = created;
            }
        }
        else
        {
            // Update
            var response = await client.PutAsJsonAsync($"api/testplans/{EditingPlan.Id}", EditingPlan);
            if (response.IsSuccessStatusCode)
            {
                // Re-fetch the updated plan from backend
                var updated = await client.GetFromJsonAsync<TestPlan>($"api/testplans/{EditingPlan.Id}");
                if (updated != null)
                    EditingPlan = updated;
            }
        }
        ShowPlanDialog = false;
        await LoadPlans();
    }

    private async Task DeletePlan(TestPlan plan)
    {
        var client = HttpFactory.CreateClient("Api");
        await client.DeleteAsync($"api/testplans/{plan.Id}");
        await LoadPlans();
    }
}
