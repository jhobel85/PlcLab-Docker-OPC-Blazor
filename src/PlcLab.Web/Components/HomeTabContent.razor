@using PlcLab.Web.ViewModel
@using Microsoft.AspNetCore.Components
@code {
    [Parameter] public IndexViewModel? ViewModel { get; set; }
    private double? _addMethodResult;
    private string? _addMethodDebug;

    protected override async Task OnInitializedAsync()
    {
        if (ViewModel != null)
        {
            ViewModel.Connected += OnConnected;
            ViewModel.StatusChanged += OnStatusChanged;
            await ViewModel.LoadSeedInfoAsync();
            await FetchAddMethodResultAsync();
        }
    }

    private async void OnConnected()
    {
        if (ViewModel != null)
        {
            await ViewModel.LoadSeedInfoAsync();
            await FetchAddMethodResultAsync();
            StateHasChanged();
        }
    }

    private void OnStatusChanged()
    {
        if (ViewModel == null || ViewModel.Session == null || !ViewModel.Session.Connected)
        {
            _addMethodResult = null;
            _addMethodDebug = null;
            if (ViewModel != null) ViewModel.ClearSeedInfo();
            StateHasChanged();
        }
    }

    private async Task FetchAddMethodResultAsync()
    {
        _addMethodResult = null;
        _addMethodDebug = null;
        try
        {
            var http = new HttpClient { BaseAddress = new Uri(NavigationManager.BaseUri) };
            var response = await http.GetAsync("api/seedinfo");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                using var doc = System.Text.Json.JsonDocument.Parse(json);
                if (doc.RootElement.TryGetProperty("result", out var resultElem) && resultElem.ValueKind != System.Text.Json.JsonValueKind.Null)
                    _addMethodResult = resultElem.GetDouble();
                if (doc.RootElement.TryGetProperty("debug", out var debugElem))
                    _addMethodDebug = debugElem.GetString();
            }
        }
        catch (Exception ex)
        {
            _addMethodDebug = $"Error fetching method result: {ex.Message}";
        }
    }

    private async Task OnRefreshSeedData()
    {
        if (ViewModel != null)
        {
            await ViewModel.LoadSeedInfoAsync();
            await FetchAddMethodResultAsync();
            StateHasChanged();
        }
    }
    [Inject] NavigationManager NavigationManager { get; set; } = default!;
}

<h4>Welcome to PlcLab</h4>
<div>
  <p>OPC UA application: @ViewModel?.UaFactory.GetApplicationName()</p>

  <div class="d-flex align-items-center mb-2">
    <span><strong>Click Count:</strong> @(ViewModel?.ClickCount ?? 0) (test to verify component is interactive)</span>
    <button class="btn btn-secondary ms-3" @onclick="() => ViewModel?.TestButtonClick()">Test Button</button>
  </div>
</div>

<div class="mt-4">
    <LiveSignals Session="@(ViewModel?.Session)" />
</div>

<div class="mt-4">
    <RunWizard />
</div>

@if (ViewModel?.Session != null && ViewModel.Session.Connected)
{
    <div class="alert alert-info mt-3">
        <div class="d-flex align-items-center mb-2">
            <strong>Static (Seed) Data :</strong>
            <button class="btn btn-sm btn-outline-secondary ms-3" @onclick="OnRefreshSeedData" title="Refresh Seed Data">
                <span class="bi-arrow-clockwise"></span> Refresh
            </button>
        </div>
        @if (ViewModel?.SeedInfo?.Variables?.Count > 0)
        {
            <ul>
                @foreach (var v in ViewModel.SeedInfo.Variables)
                {
                    <li>
                        <b>@v.Label</b> (<code>@v.NodeId</code>): <span>@v.Value</span>
                    </li>
                }
                @if (_addMethodResult != null || !string.IsNullOrEmpty(_addMethodDebug))
                {
                    <li class="mt-2">
                        <div class="ms-3 text-muted">Method 'Add' result: <b>@_addMethodResult</b></div>
                        @if (!string.IsNullOrEmpty(_addMethodDebug))
                        {
                            <div class="ms-3 small">@_addMethodDebug</div>
                        }
                    </li>
                }
            </ul>
        }
        else
        {
            <span>No demo variables found or OPC UA server not reachable.</span>
        }
    </div>
}
else
{
    <div class="alert alert-warning mt-3">
        No OPC UA session. Please connect to see static (seed) data.
    </div>
}