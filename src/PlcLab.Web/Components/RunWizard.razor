@inject NavigationManager NavigationManager
@inject IHttpClientFactory HttpFactory

<h5>Run Wizard</h5>
@if (TestPlans == null)
{
    <div>Loading test plans...</div>
}
else
{
    <div>
        <label for="planSelect"><b>Select Test Plan:</b></label>
        <select id="planSelect" class="form-select w-auto d-inline-block mx-2" @bind="SelectedPlanId">
            <option value="">-- Select --</option>
            @foreach (var plan in TestPlans)
            {
                <option value="@plan.Id">@plan.Name</option>
            }
        </select>
        <button class="btn btn-primary ms-2" @onclick="StartRun" disabled="@(string.IsNullOrEmpty(SelectedPlanId) || IsRunning)">Start</button>
    </div>
    @if (IsRunning)
    {
        <div class="mt-3">
            <b>Progress:</b> @Progress%
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: @Progress%" aria-valuenow="@Progress" aria-valuemin="0" aria-valuemax="100">@Progress%</div>
            </div>
            <div class="mt-2">@StatusMessage</div>
        </div>
    }
    @if (!string.IsNullOrEmpty(ResultMessage))
    {
        <div class="alert alert-success mt-3">@ResultMessage</div>
    }
}

@code {
    private List<TestPlan> TestPlans = new();
    private string? SelectedPlanId;
    private bool IsRunning;
    private int Progress;
    private string StatusMessage = string.Empty;
    private string ResultMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTestPlans();
    }

    private async Task LoadTestPlans()
    {
        try
        {
            var client = HttpFactory.CreateClient("Api");
            var plans = await client.GetFromJsonAsync<List<TestPlan>>("api/testplans");
            TestPlans = plans ?? new();
        }
        catch (Exception ex)
        {
            StatusMessage = $"Failed to load test plans: {ex.Message}";
            TestPlans = new();
        }
    }

    private async Task StartRun()
    {
        if (string.IsNullOrEmpty(SelectedPlanId)) return;
        var plan = TestPlans.FirstOrDefault(p => p.Id == SelectedPlanId);
        if (plan == null)
        {
            StatusMessage = "Test plan not found.";
            return;
        }
        IsRunning = true;
        Progress = 0;
        StatusMessage = "Starting test run...";
        ResultMessage = string.Empty;
        StateHasChanged();

        try
        {
            var client = HttpFactory.CreateClient("Api");
            // Start the test run via API (POST to /api/testruns or similar)
            var response = await client.PostAsJsonAsync($"api/testruns", new { TestPlanId = plan.Id });
            response.EnsureSuccessStatusCode();
            // Optionally poll for progress or just simulate for now
            for (int i = 1; i <= 10; i++)
            {
                await Task.Delay(400);
                Progress = i * 10;
                StatusMessage = $"Running step {i} of 10...";
                StateHasChanged();
            }
            StatusMessage = "Test run complete.";
            ResultMessage = $"Test plan '{plan.Name}' completed successfully.";
        }
        catch (Exception ex)
        {
            StatusMessage = $"Test run failed: {ex.Message}";
            ResultMessage = string.Empty;
        }
        finally
        {
            IsRunning = false;
            StateHasChanged();
        }
    }

    public class TestPlan
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
    }
}
