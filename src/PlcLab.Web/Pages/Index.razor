
@page "/"
@rendermode @(new InteractiveServerRenderMode())
@using PlcLab.OPC
@using Opc.Ua.Client
@using Microsoft.AspNetCore.Components.Web
@inject IOpcUaClientFactory UaFactory
@inject IConfiguration Configuration

<h4>Welcome to PlcLab</h4>
<div>
  <p>OPC UA application: @UaFactory.GetApplicationName()</p>
  <p><strong>Status:</strong> @_opcStatus @if (_session != null) { <span>(Session: @_session.SessionId)</span> }</p>
  <p><strong>Click Count:</strong> @_clickCount (test to verify component is interactive)</p>
  <button class="btn btn-primary" @onclick="ReconnectAsync" disabled="@_isConnecting">Reconnect</button>
  <button class="btn btn-secondary" @onclick="TestButtonClick">Test Button</button>
</div>

@if (_seedInfo != null && _seedInfo.seedEnabled)
{
  <div class="alert alert-info mt-3">
    <strong>Seed Data (Demo Variables):</strong>
    @if (_seedInfo.variables?.Count > 0)
    {
      <ul>
        @foreach (var v in _seedInfo.variables)
        {
          <li><b>@v.Label</b> (<code>@v.Path</code>): <span>@v.Value</span></li>
        }
      </ul>
    }
    else
    {
      <span>No demo variables found or OPC UA server not reachable.</span>
    }
  </div>
}

@code {

  private string _opcStatus = "Not connected";
  private bool _isConnecting;
  private Session? _session;
  private int _clickCount = 0;

  private SeedInfo? _seedInfo;


  protected override async Task OnInitializedAsync()
  {
    Console.WriteLine("Component initialized - OnInitializedAsync called");
    await TryConnectAsync();
    await LoadSeedInfoAsync();
  }

  private async Task LoadSeedInfoAsync()
  {
    try
    {
      var http = new HttpClient { BaseAddress = new Uri(NavigationManager.BaseUri) };
      var resp = await http.GetAsync("api/seedinfo");
      if (resp.IsSuccessStatusCode)
      {
        var json = await resp.Content.ReadAsStringAsync();
        _seedInfo = System.Text.Json.JsonSerializer.Deserialize<SeedInfo>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
      }
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Failed to load seed info: {ex.Message}");
    }
    StateHasChanged();
  }

  [Inject] NavigationManager NavigationManager { get; set; } = default!;

  public class SeedInfo
  {
    public bool seedEnabled { get; set; }
    public List<SeedVariable> variables { get; set; } = new();
  }
  public class SeedVariable
  {
    public string Label { get; set; } = string.Empty;
    public string Path { get; set; } = string.Empty;
    public string Value { get; set; } = string.Empty;
  }

  private async Task ReconnectAsync()
  {
    await TryConnectAsync();
  }

  private void TestButtonClick()
  {
    Console.WriteLine("TestButtonClick method called!");
    _clickCount++;
    Console.WriteLine($"Test button clicked. Count: {_clickCount}");
    StateHasChanged();
  }

  private async Task TryConnectAsync()
  {
    var endpoint = Configuration["OpcUa:Endpoint"] ?? "opc.tcp://localhost:4840";

    _isConnecting = true;
    _opcStatus = $"Connecting to {endpoint}...";
    StateHasChanged();

    try
    {
      // Close existing session if present
      if (_session != null)
      {
        var oldSessionId = _session.SessionId?.ToString() ?? "(unknown)";
        Console.WriteLine($"[Reconnect] Closing old session: {oldSessionId}");
        
        try
        {
          await _session.CloseAsync();
          Console.WriteLine($"[Reconnect] Old session closed successfully");
        }
        catch (Exception closeEx)
        {
          Console.WriteLine($"[Reconnect] Error closing old session: {closeEx.Message}");
        }
        finally
        {
          _session.Dispose();
          _session = null;
        }
      }

      // Wait a bit for server to fully release the old session before creating a new one
      // This ensures the new session gets a fresh session ID
      Console.WriteLine("[Reconnect] Waiting 1000ms before creating new session");
      await Task.Delay(1000);

      Console.WriteLine("[Reconnect] Creating new session");
      _session = await UaFactory.CreateSessionAsync(endpoint, useSecurity: false);
      var sessionId = _session?.SessionId?.ToString() ?? "(unknown)";
      Console.WriteLine($"[Reconnect] New session created with ID: {sessionId}");
      _opcStatus = $"Connected (SessionId: {sessionId})";
    }
    catch (Exception ex)
    {
      Console.WriteLine($"[Reconnect] Exception: {ex.Message}");
      Console.WriteLine($"[Reconnect] StackTrace: {ex.StackTrace}");
      _opcStatus = $"Connection failed: {ex.Message}";
    }
    finally
    {
      _isConnecting = false;
      StateHasChanged();
    }
  }
}
