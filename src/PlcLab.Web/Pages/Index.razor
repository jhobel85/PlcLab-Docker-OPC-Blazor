
@page "/"
@rendermode @(new InteractiveServerRenderMode())
@using PlcLab.OPC
@using PlcLab.Web.Pages
@using PlcLab.Web.Models
@using PlcLab.Infrastructure
@using Microsoft.AspNetCore.Components.Web
@inject IOpcUaClientFactory UaFactory
@inject IConfiguration Configuration
@inject DemoDataSeederHostedService AddService
@inject NavigationManager NavigationManager

@code {
    private IndexViewModel? _vm;


    protected override async Task OnInitializedAsync()
    {
    _vm = new IndexViewModel(UaFactory, Configuration, AddService, NavigationManager);
    await _vm.InitializeAsync();
    StateHasChanged();
  }
}

<h4>Welcome to PlcLab</h4>
<div>
  <p>OPC UA application: @UaFactory.GetApplicationName()</p>
  <p><strong>Status:</strong> @_vm.OpcStatus @if (_vm.Session != null) { <span>(Session: @_vm.Session.SessionId)</span> }</p>
  <p><strong>Click Count:</strong> @_vm.ClickCount (test to verify component is interactive)</p>
  <button class="btn btn-primary" @onclick="_vm.ReconnectAsync" disabled="@_vm.IsConnecting">Reconnect</button>
  <button class="btn btn-secondary" @onclick="_vm.TestButtonClick">Test Button</button>
</div>

@if (_vm.SeedInfo != null && _vm.SeedInfo.SeedEnabled)
{
  <div class="alert alert-info mt-3">
    <strong>Seed Data (Demo Variables):</strong>
    @if (_vm.SeedInfo.Variables?.Count > 0)
    {
      <ul>
        @foreach (var v in _vm.SeedInfo.Variables)
        {
          <li><b>@v.Label</b> (<code>@v.Path</code>): <span>@v.Value</span></li>
        }
      </ul>
    }
    else
    {
      <span>No demo variables found or OPC UA server not reachable.</span>
    }
  </div>

  <div class="alert alert-secondary mt-3">
    <strong>Demo Methods:</strong>
    <div class="input-group mb-2 mt-2">
      <input type="number" class="form-control" placeholder="Number 1" @bind="_vm.AddNum1" />
      <input type="number" class="form-control" placeholder="Number 2" @bind="_vm.AddNum2" />
      <button class="btn btn-success" @onclick="_vm.CallAddMethodAsync" disabled="@(_vm.Session == null)">Add</button>
    </div>
    @if (_vm.AddResult != null)
    {
      <div class="alert alert-success">Add Result: <strong>@_vm.AddResult</strong></div>
    }
    @if (!string.IsNullOrEmpty(_vm.AddError))
    {
      <div class="alert alert-danger">Error: @_vm.AddError</div>
    }
  </div>
}
